{"ast":null,"code":"/**\r\n * Copyright(c) Live2D Inc. All rights reserved.\r\n *\r\n * Use of this source code is governed by the Live2D Open Software license\r\n * that can be found at https://www.live2d.com/eula/live2d-open-software-license-agreement_en.html.\r\n */\n\nimport { Live2DCubismFramework as csmvector } from '../Framework/src/type/csmvector';\nvar Csm_csmVector = csmvector.csmVector;\nvar csmVector_iterator = csmvector.iterator;\nimport { gl } from './lappdelegate';\n\n/**\r\n * テクスチャ管理クラス\r\n * 画像読み込み、管理を行うクラス。\r\n */\nexport class LAppTextureManager {\n  /**\r\n   * コンストラクタ\r\n   */\n  constructor() {\n    this._textures = void 0;\n    this._textures = new Csm_csmVector();\n  }\n\n  /**\r\n   * 解放する。\r\n   */\n  release() {\n    for (let ite = this._textures.begin(); ite.notEqual(this._textures.end()); ite.preIncrement()) {\n      gl.deleteTexture(ite.ptr().id);\n    }\n    this._textures = null;\n  }\n\n  /**\r\n   * 图像读取\r\n   *\r\n   * @param fileName 读取的图像文件路径名称\r\n   * @param usePremultiply 是否启用Premiult处理\r\n   * @return 图像信息读取失败时返回null\r\n   */\n  createTextureFromPngFile(fileName, usePremultiply, callback) {\n    // search loaded texture already\n    for (let ite = this._textures.begin(); ite.notEqual(this._textures.end()); ite.preIncrement()) {\n      if (ite.ptr().fileName == fileName && ite.ptr().usePremultply == usePremultiply) {\n        // 第二次以后使用缓存（无等待时间）\n        // 在WebKit中，要再次调用相同Image的onload，需要再次实例\n        // 詳細：https://stackoverflow.com/a/5024181\n        ite.ptr().img = new Image();\n        ite.ptr().img.onload = () => callback(ite.ptr());\n        ite.ptr().img.src = fileName;\n        return;\n      }\n    }\n\n    // データのオンロードをトリガーにする\n    const img = new Image();\n    img.onload = () => {\n      // テクスチャオブジェクトの作成\n      const tex = gl.createTexture();\n\n      // テクスチャを選択\n      gl.bindTexture(gl.TEXTURE_2D, tex);\n\n      // テクスチャにピクセルを書き込む\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_LINEAR);\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\n\n      // Premult処理を行わせる\n      if (usePremultiply) {\n        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 1);\n      }\n\n      // テクスチャにピクセルを書き込む\n      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);\n\n      // ミップマップを生成\n      gl.generateMipmap(gl.TEXTURE_2D);\n\n      // テクスチャをバインド\n      gl.bindTexture(gl.TEXTURE_2D, null);\n      const textureInfo = new TextureInfo();\n      if (textureInfo != null) {\n        textureInfo.fileName = fileName;\n        textureInfo.width = img.width;\n        textureInfo.height = img.height;\n        textureInfo.id = tex;\n        textureInfo.img = img;\n        textureInfo.usePremultply = usePremultiply;\n        this._textures.pushBack(textureInfo);\n      }\n      callback(textureInfo);\n    };\n    img.src = fileName;\n    //  添加允许图片资源跨域请求\n    img.crossOrigin = \"anonymous\";\n  }\n\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 配列に存在する画像全てを解放する。\r\n   */\n  releaseTextures() {\n    for (let i = 0; i < this._textures.getSize(); i++) {\n      this._textures.set(i, null);\n    }\n    this._textures.clear();\n  }\n\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 指定したテクスチャの画像を解放する。\r\n   * @param texture 解放するテクスチャ\r\n   */\n  releaseTextureByTexture(texture) {\n    for (let i = 0; i < this._textures.getSize(); i++) {\n      if (this._textures.at(i).id != texture) {\n        continue;\n      }\n      this._textures.set(i, null);\n      this._textures.remove(i);\n      break;\n    }\n  }\n\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 指定した名前の画像を解放する。\r\n   * @param fileName 解放する画像ファイルパス名\r\n   */\n  releaseTextureByFilePath(fileName) {\n    for (let i = 0; i < this._textures.getSize(); i++) {\n      if (this._textures.at(i).fileName == fileName) {\n        this._textures.set(i, null);\n        this._textures.remove(i);\n        break;\n      }\n    }\n  }\n}\n\n/**\r\n * 画像情報構造体\r\n */\nexport class TextureInfo {\n  constructor() {\n    this.img = void 0;\n    // 画像\n    this.id = null;\n    // テクスチャ\n    this.width = 0;\n    // 横幅\n    this.height = 0;\n    // 高さ\n    this.usePremultply = void 0;\n    // Premult処理を有効にするか\n    this.fileName = void 0;\n  } // ファイル名\n}","map":{"version":3,"names":["Live2DCubismFramework","csmvector","Csm_csmVector","csmVector","csmVector_iterator","iterator","gl","LAppTextureManager","constructor","_textures","release","ite","begin","notEqual","end","preIncrement","deleteTexture","ptr","id","createTextureFromPngFile","fileName","usePremultiply","callback","usePremultply","img","Image","onload","src","tex","createTexture","bindTexture","TEXTURE_2D","texParameteri","TEXTURE_MIN_FILTER","LINEAR_MIPMAP_LINEAR","TEXTURE_MAG_FILTER","LINEAR","pixelStorei","UNPACK_PREMULTIPLY_ALPHA_WEBGL","texImage2D","RGBA","UNSIGNED_BYTE","generateMipmap","textureInfo","TextureInfo","width","height","pushBack","crossOrigin","releaseTextures","i","getSize","set","clear","releaseTextureByTexture","texture","at","remove","releaseTextureByFilePath"],"sources":["C:/Users/cleyc/OneDrive/Documents/RR/RRWebsiteRenewed/my-app/src/mylive2d/react-live2d/Samples/TypeScript/Demo/src/lapptexturemanager.ts"],"sourcesContent":["/**\r\n * Copyright(c) Live2D Inc. All rights reserved.\r\n *\r\n * Use of this source code is governed by the Live2D Open Software license\r\n * that can be found at https://www.live2d.com/eula/live2d-open-software-license-agreement_en.html.\r\n */\r\n\r\nimport { Live2DCubismFramework as csmvector } from '../Framework/src/type/csmvector';\r\nimport Csm_csmVector = csmvector.csmVector;\r\nimport csmVector_iterator = csmvector.iterator;\r\nimport { gl } from './lappdelegate';\r\n\r\n/**\r\n * テクスチャ管理クラス\r\n * 画像読み込み、管理を行うクラス。\r\n */\r\nexport class LAppTextureManager {\r\n  /**\r\n   * コンストラクタ\r\n   */\r\n  constructor() {\r\n    this._textures = new Csm_csmVector<TextureInfo>();\r\n  }\r\n\r\n  /**\r\n   * 解放する。\r\n   */\r\n  public release(): void {\r\n    for (\r\n      let ite: csmVector_iterator<TextureInfo> = this._textures.begin();\r\n      ite.notEqual(this._textures.end());\r\n      ite.preIncrement()\r\n    ) {\r\n      gl.deleteTexture(ite.ptr().id);\r\n    }\r\n    this._textures = null;\r\n  }\r\n\r\n  /**\r\n   * 图像读取\r\n   *\r\n   * @param fileName 读取的图像文件路径名称\r\n   * @param usePremultiply 是否启用Premiult处理\r\n   * @return 图像信息读取失败时返回null\r\n   */\r\n  public createTextureFromPngFile(\r\n    fileName: string,\r\n    usePremultiply: boolean,\r\n    callback: (textureInfo: TextureInfo) => void\r\n  ): void {\r\n    // search loaded texture already\r\n    for (\r\n      let ite: csmVector_iterator<TextureInfo> = this._textures.begin();\r\n      ite.notEqual(this._textures.end());\r\n      ite.preIncrement()\r\n    ) {\r\n      if (\r\n        ite.ptr().fileName == fileName &&\r\n        ite.ptr().usePremultply == usePremultiply\r\n      ) {\r\n        // 第二次以后使用缓存（无等待时间）\r\n        // 在WebKit中，要再次调用相同Image的onload，需要再次实例\r\n        // 詳細：https://stackoverflow.com/a/5024181\r\n        ite.ptr().img = new Image();\r\n        ite.ptr().img.onload = (): void => callback(ite.ptr());\r\n        ite.ptr().img.src = fileName;\r\n        return;\r\n      }\r\n    }\r\n\r\n    // データのオンロードをトリガーにする\r\n    const img = new Image();\r\n    img.onload = (): void => {\r\n      // テクスチャオブジェクトの作成\r\n      const tex: WebGLTexture = gl.createTexture();\r\n\r\n      // テクスチャを選択\r\n      gl.bindTexture(gl.TEXTURE_2D, tex);\r\n\r\n      // テクスチャにピクセルを書き込む\r\n      gl.texParameteri(\r\n        gl.TEXTURE_2D,\r\n        gl.TEXTURE_MIN_FILTER,\r\n        gl.LINEAR_MIPMAP_LINEAR\r\n      );\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n\r\n      // Premult処理を行わせる\r\n      if (usePremultiply) {\r\n        gl.pixelStorei(gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 1);\r\n      }\r\n\r\n      // テクスチャにピクセルを書き込む\r\n      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);\r\n\r\n      // ミップマップを生成\r\n      gl.generateMipmap(gl.TEXTURE_2D);\r\n\r\n      // テクスチャをバインド\r\n      gl.bindTexture(gl.TEXTURE_2D, null);\r\n\r\n      const textureInfo: TextureInfo = new TextureInfo();\r\n      if (textureInfo != null) {\r\n        textureInfo.fileName = fileName;\r\n        textureInfo.width = img.width;\r\n        textureInfo.height = img.height;\r\n        textureInfo.id = tex;\r\n        textureInfo.img = img;\r\n        textureInfo.usePremultply = usePremultiply;\r\n        this._textures.pushBack(textureInfo);\r\n      }\r\n\r\n      callback(textureInfo);\r\n    };\r\n    img.src = fileName;\r\n    //  添加允许图片资源跨域请求\r\n    img.crossOrigin = \"anonymous\";\r\n  }\r\n\r\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 配列に存在する画像全てを解放する。\r\n   */\r\n  public releaseTextures(): void {\r\n    for (let i = 0; i < this._textures.getSize(); i++) {\r\n      this._textures.set(i, null);\r\n    }\r\n\r\n    this._textures.clear();\r\n  }\r\n\r\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 指定したテクスチャの画像を解放する。\r\n   * @param texture 解放するテクスチャ\r\n   */\r\n  public releaseTextureByTexture(texture: WebGLTexture): void {\r\n    for (let i = 0; i < this._textures.getSize(); i++) {\r\n      if (this._textures.at(i).id != texture) {\r\n        continue;\r\n      }\r\n\r\n      this._textures.set(i, null);\r\n      this._textures.remove(i);\r\n      break;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * 画像の解放\r\n   *\r\n   * 指定した名前の画像を解放する。\r\n   * @param fileName 解放する画像ファイルパス名\r\n   */\r\n  public releaseTextureByFilePath(fileName: string): void {\r\n    for (let i = 0; i < this._textures.getSize(); i++) {\r\n      if (this._textures.at(i).fileName == fileName) {\r\n        this._textures.set(i, null);\r\n        this._textures.remove(i);\r\n        break;\r\n      }\r\n    }\r\n  }\r\n\r\n  _textures: Csm_csmVector<TextureInfo>;\r\n}\r\n\r\n/**\r\n * 画像情報構造体\r\n */\r\nexport class TextureInfo {\r\n  img: HTMLImageElement; // 画像\r\n  id: WebGLTexture = null; // テクスチャ\r\n  width = 0; // 横幅\r\n  height = 0; // 高さ\r\n  usePremultply: boolean; // Premult処理を有効にするか\r\n  fileName: string; // ファイル名\r\n}\r\n"],"mappings":"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"},"metadata":{},"sourceType":"module","externalDependencies":[]}